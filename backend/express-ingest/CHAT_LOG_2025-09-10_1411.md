# Complete Handover Summary (README replacement)
## 10 September 2025 1411 CT

## 1) Live properties & URLs

**Primary app (Azure App Service):**
https://canadawill-ingest-ave2f8fjcxeuaehz.canadacentral-01.azurewebsites.net/

**Kudu (SCM) site:**
https://canadawill-ingest-ave2f8fjcxeuaehz.scm.canadacentral-01.azurewebsites.net/

**Working public endpoints observed:**

- Health: `/api/health`
- SERPHouse test: `/api/serp/test`
- Env readout: `/api/news/serp/env`
- Backfill single official: `/api/news/serp/backfill-run?who=<slug>&days=365&store=1`
- Roster backfill (run/progress): `/api/news/serp/backfill-roster` and `/api/news/serp/backfill-roster/progress?runId=<id>`

## 2) Azure resources inventory

- **App Service (Linux)**: canadawill-ingest-ave2f8fjcxeuaehz (region: Canada Central)
- **Kudu (SCM)**: as above
- **Storage account** (observed via portal instruction): canadawillfuncstore2
- **Resource group, Application Insights**: not provided

## 3) Data providers & quotas

**Providers referenced**: NewsAPI, NewsData, SERPHouse (custom client)

**Stated scope so far**: Alberta MLAs/MPs (~121 officials) completed; expansion to mayors planned

**Specific daily quotas/keys**: not provided here (see SENSITIVE appendix when supplied)

## 4) Repo & code layout vs. running app

**Observed in runtime**: Node entry under `/home/site/wwwroot/express-ingest/ingest.js` (from whoami diagnostic)

**Project files referenced in chat:**
- `server.js` (expected main with diagnostic + SERPHouse routes)
- `express-ingest/ingest.js` (was being invoked by the app)
- `serp-tools.runtime.js` (helper at root; later updated to default container "news")

**Prior Procfile/package.json interactions discussed; ultimate behavior**: app served the SERPHouse routes from server.js after fixes

## 5) What works vs what doesn't (based on observed calls)

**Works (200 / correct JSON):**
- `/api/serp/test` returned test JSON indicating mounted SERPHouse router
- `/api/news/serp/env` showed `"STORAGE":{"hasConn":true,"container":"news"}`
- `/api/news/serp/backfill-run?who=danielle-smith&days=365&store=1` executed, showed stored output and count
- `/api/health` returned `"status":"healthy"` and timestamp

**Issues previously seen (resolved):**
- Kudu VFS unauthenticated (401) in browser
- "Publish profile is invalid …" when app-name/slot didn't match secret
- "This is not the tsc command you are looking for" (TypeScript not installed initially)
- Axios missing (selftest failed); later added dependency and fixed
- Current roster backfill completed 121/121 (see Section 9)

## 6) Ingest endpoint saga — timeline (CT)

- **2025-09-08 (multiple times)**: Deployment ran wrong entrypoint (express-ingest/ingest.js); diagnostic routes missing
- **2025-09-08 (evening)**: Procfile/package.json adjustments attempted; whoami continued to show express-ingest/ingest.js
- **2025-09-08 ~20:29 CT**: SERPHouse routes confirmed working (/api/serp/test, backfill for danielle-smith, health OK); container verified as news; axios issue later addressed
- **2025-09-09**: Still interleaved misses (Kudu auth, timeouts on backfill), then storage SDK missing identified and added; env showed storage connection OK; backfill became stable
- **2025-09-09–10**: Long-run roster backfill executed; progress endpoint reported 121 processed

## 7) CI/CD realities

- Initial GitHub Actions deploy failed due to mismatched publish profile vs app name/slot ("Publish profile is invalid…")
- TypeScript compile step initially failed (no local typescript), resolved by adding npm install typescript --no-save in workflow
- Use of publish profile (App Service) inferred; SPN/client-secret path not confirmed
- Pathing/artifact drift: earlier builds referenced missing dist/providers/serphouseClient.js until fixed; later confirmed helper and compiled client present

## 8) App settings & environment

**Known active behaviors:**
- Storage container default: "news"
- Storage connection present: `"STORAGE":{"hasConn":true,"container":"news"}`

**Environment variables (names) referenced by user:**
NEWS_API_KEY, NEWSDATAIO_API_KEY, OPENAI_API_KEY, ANTHROPIC_API_KEY, AZURE_MAPS_API_KEY, GMAIL_APP_PASSWORD, AzureWebJobsStorage, others

**Exact values**: not provided here (awaiting SENSITIVE appendix)

## 9) Verification artifacts (canonical)

**Health:**
```
GET https://canadawill-ingest-ave2f8fjcxeuaehz.canadacentral-01.azurewebsites.net/api/health 
→ {"status":"healthy","timestamp":"<iso>","message":"Minimal ingest working"}
```

**SERPHouse test:**
```
GET /api/serp/test 
→ {"message":"SERPHouse test route working!","timestamp":"<iso>"}
```

**Env:**
```
GET /api/news/serp/env 
→ {"ENABLE_SERPHOUSE":true,"HAS_TOKEN":true,"ROSTER_PATH":"data/ab-roster-transformed.json","STORAGE":{"hasConn":true,"container":"news"}}
```

**Single backfill:**
```
GET /api/news/serp/backfill-run?who=danielle-smith&days=365&store=1 
→ showed count, stored JSON path, container "news"
```

**Roster backfill (progress):**
```
GET /api/news/serp/backfill-roster/progress?runId=2025-09-09T22-56-09-535Z
2025-09-09 05:59–23:03 CT range: processed counts advanced (e.g., processed: 1 then 2)
Final: processed: 121 (see Section 10)
```

## 10) Problems & why we got stuck (root causes only)

1. **Wrong entrypoint**: App started express-ingest/ingest.js instead of server.js → routes absent
2. **Artifact drift**: compiled assets (dist/providers/serphouseClient.js) missing initially → runtime require failed
3. **Dependency gaps**: axios, Azure Storage SDK absent in early deploys → runtime failures/no writes
4. **Publish profile mismatch**: app-name/slot vs secret → deployment rejected
5. **Overreach on date gate**: items stored without enforcing last-365 filter, leading to historical/irrelevant content mixed in (2017/2020/2022)

## 11) How I like to work (from user)

- Facts > theories; no unapproved assumptions
- One problem at a time; CT timestamps on all logs
- No secrets in code; deterministic, explicit deploy paths
- Clear, testable success criteria before declaring "done"
- User reviews content before deletion; keep audit trails

## 12) F-Series Roadmap (big picture only — "what")

- **F1** – SERP scrape (Phase 1): Collect headlines/URLs/snippets for Alberta MLAs/MPs. Status: done (121 officials).
- **F2** – Topic filter/triage (Phase 2): Keep items about Alberta separation/sovereignty/independence/remaining; label by reference date (2025-09-10); move off-topic into review folder; no deletions.
- **F3** – Full-text capture (Phase 3): Fetch article bodies where accessible; skip hard paywalls; store raw text alongside metadata.
- **F4** – Roster expansion: Add Alberta mayors; support periodic re-runs for MLAs/MPs and mayors.
- **F5** – Source coverage audit: Tally by domain/channel; compare to weekly newspaper list; produce coverage reports.
- **F6** – Dedupe & normalization: Consolidate duplicates across sources/URLs; canonicalize domains; unify fields.
- **F7** – Sentiment/stance scoring: Apply simple stance classification toward Alberta separation/sovereignty; per-official rollups.
- **F8** – Aggregate views: Flat exports for BI (filter by person, date bucket, source); minimal dashboards for counts and trends.
- **F9** – Scheduling & guardrails: Safe periodic jobs (backfill, filter, audit); rate-limit awareness; logs/alerts.
- **F10** – Backups & governance: Nightly storage snapshots; restore notes; change logs; "to be deleted" review gate.

## 13) Canonical references

- **App**: https://canadawill-ingest-ave2f8fjcxeuaehz.canadacentral-01.azurewebsites.net/
- **Kudu**: https://canadawill-ingest-ave2f8fjcxeuaehz.scm.canadacentral-01.azurewebsites.net/
- **Storage**: canadawillfuncstore2
- **Known endpoints**: /api/serp/test, /api/news/serp/env, /api/news/serp/backfill-run, /api/news/serp/backfill-roster/progress, /api/health

## 14) Known dead ends

- Forcing Procfile/package.json switches without confirming runtime file layout → didn't flip entrypoint
- Relying on Kudu VFS unauthenticated browser check for artifacts → always 401
- Proceeding with runtime date logic change without explicit approval → captured older articles and off-topic items

## 15) Open questions

- Exact repository layout (paths to server.js, helpers, rosters), and whether dist bundling is in CI
- Full list of app settings with values and which app(s) they're applied to
- Resource group name(s), Insights instance name
- Are scheduled backfills/Audit already merged in CI, or still pending?

---

## Appendix — App Settings & Secrets (SENSITIVE – DO NOT COMMIT)

**Awaiting provided values:**
- NEWS_API_KEY=…
- NEWSDATAIO_API_KEY=…
- OPENAI_API_KEY=…
- ANTHROPIC_API_KEY=…
- AZURE_MAPS_API_KEY=…
- GMAIL_APP_PASSWORD=…
- AzureWebJobsStorage=…
- any others currently configured (name=value)
