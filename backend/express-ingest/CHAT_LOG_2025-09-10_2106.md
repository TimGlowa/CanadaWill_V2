# Complete Handover Summary (final)
## 10 September 2025 2106 CT

## 1) Live properties & URLs

* **App Service (Linux):** `https://canadawill-ingest-ave2f8fjcxeuaehz.canadacentral-01.azurewebsites.net/`
* **Kudu (SCM):** `https://canadawill-ingest-ave2f8fjcxeuaehz.scm.canadacentral-01.azurewebsites.net/`
* **Health:** `/api/health`
* **Build info (if present):** `/api/buildinfo`
* **SERPHouse:**

  * test: `/api/serp/test`
  * env: `/api/news/serp/env`
  * single backfill: `/api/news/serp/backfill-run?who=<slug>&days=365&store=1`
  * roster backfill progress: `/api/news/serp/backfill-roster/progress?runId=<id>`

## 2) Azure resources

* **Resource group:** `CanadaWill-prod2-rg`
* **App Insights:** `canadawill-ingest` (components)
* **Storage account:** `canadawillfuncstore2`
* **Region:** Canada Central

## 3) Providers in scope

* **Primary:** SERPHouse
* **Optional:** NewsAPI, NewsDataIO (not currently wired; keys not present)

## 4) Data storage

* **Container:** `news`
* **SERP dumps:** `raw/serp/<slug>/<ISO8601>.json`
  example: `raw/serp/adriana-lagrange/2025-09-10T05-22-42-190Z.json`
* **Review queue (no deletes):** `to_be_deleted/<slug>/<ISO8601>.json`

## 5) Labels and rules

* **Pro Canada**, **Pro Separation**, **No Comment**.
* Treat **statehood/independence/separation** as **Pro Separation** unless the content is an explicit pro-Canada rebuttal.
* "Sovereignty/autonomy/jurisdiction" without an explicit for/against leaving → **No Comment**.

## 6) CI/CD (GitHub Actions)

* **Active workflows:**

  * `.github/workflows/deploy-backend.yml`
  * `.github/workflows/ci.yml`
  * `.github/workflows/auto-merge-enable.yml`
* **Deploy method:** Publish profile (`AZURE_WEBAPP_PUBLISH_PROFILE`)
* **Build:** TypeScript compiles to `dist/`; published by workflow

## 7) Runtime and entrypoint

* **Node:** 20.19.4
* **Boot file in prod:** `server.js` (deploy workflow stages this)
  Note: `root package.json` has `start: node express-ingest/standalone.js` but is superseded by workflow staging. No `Procfile`.

## 8) App settings (names only; current)

```
ANTHROPIC_API_KEY
AZURE_MAPS_API_KEY
AZURE_STORAGE_CONNECTION
ENABLE_ROUTE_DUMP
ENABLE_SERPHOUSE
FUNCTIONS_BASE_URL
GMAIL_APP_PASSWORD
NODE_ENV
OPENAI_API_KEY
PORT
REPRESENT_API_BASE_URL
ROSTER_PATH
SCM_DO_BUILD_DURING_DEPLOYMENT
SERPHOUSE_API_TOKEN
WEBSITE_HEALTHCHECK_MAXPINGFAILURES
WEBSITE_HEALTHCHECK_PATH
WEBSITE_NODE_DEFAULT_VERSION
WEBSITE_RUN_FROM_PACKAGE
WEBSITES_NODE_DEFAULT_VERSION
WEBSITES_PORT
```

* **Intentionally absent (not used):** `NEWS_API_KEY`, `NEWSDATAIO_API_KEY`, `AzureWebJobsStorage`

## 9) Legacy Functions

* `host.json` present; multiple legacy `function.json` files exist. No effect on the Express app.

## 10) Telemetry

* **Use Application Insights** for requests, dependencies, and run markers.
* Target sampling: **100%** for backfill/triage runs and failures; **~10%** steady-state.

---

# Development Log update (CT)

* **2025-09-10 14:20 CT** — **Design scope locked**: F2 triage uses reference date **2025-09-10**; off-topic items move to `to_be_deleted/*`; no deletions. Labels set to Pro Canada, Pro Separation, No Comment; statehood maps to Pro Separation unless explicit pro-Canada rebuttal.
* **2025-09-10 14:22 CT** — **Infra truth confirmed**: RG `CanadaWill-prod2-rg`; App Insights `canadawill-ingest`; Storage `canadawillfuncstore2`; container `news`.
* **2025-09-10 14:24 CT** — **CI/CD confirmed**: Active workflows `deploy-backend.yml`, `ci.yml`, `auto-merge-enable.yml`; deploy via publish profile secret; Node 20.19.4; workflow stages `server.js` as prod entry.
* **2025-09-10 14:26 CT** — **Providers set**: SERPHouse only in production; NewsAPI/NewsDataIO optional but not configured; keys intentionally absent.
* **2025-09-10 14:28 CT** — **Storage schema fixed**: `raw/serp/<slug>/<ISO>.json`; review queue `to_be_deleted/<slug>/<ISO>.json`.
* **2025-09-10 14:30 CT** — **Telemetry**: App Insights required; Functions `host.json` sampling exclusion noted as legacy with no effect on Express.

---

# KISS next steps (Azure-only + GitHub/Cursor)

## A) Lock telemetry and health

1. **Azure Portal → Application Insights → Monitoring → Logs**

   * Create a saved query `BackfillRuns` that filters requests by route contains `backfill` and extracts `runId`, `duration`, `result`, and count.
2. **Azure Portal → App Service → Configuration → Application settings**

   * Add (names only if missing): `WEBSITE_HEALTHCHECK_PATH=/api/health`, `ENABLE_SERPHOUSE=true`.
   * Save + Restart.

## B) Triage (F2) routing in code

1. **Cursor** open repo → confirm these folders exist in storage handling:

   * `raw/serp/*` and `to_be_deleted/*`.
2. Ensure the triage step writes off-topic items to `to_be_deleted/<slug>/<ISO>.json` and never deletes.
3. Commit message: `feat(triage): route off-topic to to_be_deleted; preserve originals`.

## C) Mayors (F4) gating

1. After F2 baseline is clean for MLA/MPs, enable the roster for mayors.
2. **Cursor** add roster file and wire to the existing backfill route: keep same schema and reference date logic.
3. Commit: `feat(roster): add mayors roster; reuse F2 triage rules`.

## D) Observability sanity checks

1. **Azure Portal → App Service → Log Stream**

   * Copy 20–40 lines around the last cold start into the dev log for traceability.
2. **Kudu (SCM) → Debug console → site/wwwroot**

   * Capture filenames only for `/site/wwwroot` and `/site/wwwroot/express-ingest` into the dev log.

## E) Verification checklist (one pass)

* `GET https://canadawill-ingest-ave2f8fjcxeuaehz.canadacentral-01.azurewebsites.net/api/health` → 200 OK.
* `GET .../api/serp/test` → success JSON.
* `GET .../api/news/serp/env` → shows `ENABLE_SERPHOUSE: true`, container `news`.
* Run one person:
  `GET .../api/news/serp/backfill-run?who=danielle-smith&days=365&store=1` → stored key under `raw/serp/danielle-smith/...json`.
* Confirm App Insights has entries for the run with `runId`.

---

# What I still need pasted (once, from Azure portal)

* **Log Stream**: 20–40 lines around the last cold start.
* **Kudu filenames**: `/site/wwwroot` and `/site/wwwroot/express-ingest` (filenames only).
* **Full YAML** for the three workflows (if not already committed in main), so I can embed the exact copies in the dossier.

If you want, I can also package this summary into two files (README replacement + Dev Log) ready to paste into the repo.


