# Complete Handover Summary (README replacement)

## MISSING ARTIFACTS (provide once, then this dossier is complete)

* Exact values for **all** App Settings & Keys (NEWS\_API\_KEY, NEWSDATAIO\_API\_KEY, OPENAI\_API\_KEY, ANTHROPIC\_API\_KEY, AZURE\_MAPS\_API\_KEY, GMAIL\_APP\_PASSWORD, AzureWebJobsStorage, and any others presently configured).
* Current **README.md**, **Development Log**, CI/CD YAMLs, any **host.json/function.json**, and top-level **package.json/tsconfig** from the repo you are treating as source-of-truth.
* Frontend/App URLs (if any) beyond the ingest service.
* Storage account name(s) and container list(s) beyond what appears in logs.
* Any Kudu/Portal screenshots you want embedded (optional).

> Proceeding with everything we **do** have below.

---

## Section 1: Live properties & URLs

* **Azure App Service (ingest)**
  Base: `https://canadawill-ingest-ave2f8fjcxeuaehz.canadacentral-01.azurewebsites.net`
  SCM/Kudu: `https://canadawill-ingest-ave2f8fjcxeuaehz.scm.canadacentral-01.azurewebsites.net`

* **Canonical diagnostics endpoints observed (when ingest successfully loaded):**

  * `/api/health` (200 when healthy)
  * `/api/routes` (JSON route dump when ingest loaded)
  * `/api/news/serp/env`, `/api/news/serp/selftest`, `/api/news/serp/refresh`, `/api/news/serp/backfill`
  * `/api/roster/lookup`, `/api/roster/search`
  * `/api/news/serp/vendor-probe`, `/api/serp/ping`, `/api/serp/ping-hard`
  * At times, additional routes were present: `/api/news/serp/backfill_stub`, `/api/news/serp/backfill-patch` (duplicate lines), `/api/news/serp/backfill-diag`, `/api/news/serp/backfill-run`.

> Frontend/app URLs: **not provided**.

---

## Section 2: Azure resources inventory

* **App Service (Linux)**: `canadawill-ingest-ave2f8fjcxeuaehz` (Region: Canada Central)
  Node.js runtime per Oryx: **v20.19.3**
  Container images observed: `appsvc/node:20-lts_20250724.2.tuxprod`

* **Kudu/SCM**: Version lines captured (see Appendix D).

* **Storage**: Account/container names: **not provided** (blobs referred to as `news/...` in PRD; previously "articles" existed and was deleted).

* **Application Insights**: not listed; logs indicate "Environment Variables for Application Insight's IPA Codeless Configuration exists.." (no resource name provided).

---

## Section 3: Data providers & quotas (as stated)

* **SERPHouse** (primary provider; vendor endpoints built into ingest).
* **NewsAPI** (100/day) – disabled when `NEWS_API_KEY` unset (log: *"NewsAPI client disabled: NEWS\_API\_KEY not set"*).
* **NewsData.io** (200/day) – disabled when `NEWSDATAIO_API_KEY` unset (same pattern).

**Scope:** \~121 elected officials (MLAs + MPs). Mayors planned later (not active here).

---

## Section 4: Repo & code layout vs. what's actually running

**Observed startup behavior (BOOT.log snippets):**

* The runtime tries candidate paths in order:

  1. `./ingest-minimal.js` (often fails due to `Cannot find module './routes/serp-unlimited'`)
  2. `./express-ingest/dist/ingest` (often fails: `Cannot find module './express-ingest/dist/ingest'`)
  3. `./express-ingest/ingest` (**succeeds**) → *"\[BOOT] ingest module loaded from ./express-ingest/ingest"*.

**What's actually in `/home/site/wwwroot` (server):**

* `server.js` (entrypoint) → loads `express-ingest/ingest.js`
* `express-ingest/ingest.js` (live) registers core news/roster routes and shows live route dump.
* Extra files exist on server that are **not** shown as part of the local repo in this thread:

  * `express-ingest/diagnostics.runtime.js` (present and active at times)
  * Multiple `*.bak` snapshots of `ingest.js` and `serp-tools.runtime.js`
  * This indicates **deployment drift**: the server contains files beyond your current repository state.

**Mismatch call-outs:**

* Duplicate route registrations (`/api/news/serp/backfill-patch`) appeared in the live route list while not present (twice) in local code.
* A "stub" route (`/api/news/serp/backfill_stub`) was active on server without matching local code referenced here.
* Conclusion: app runs `express-ingest/ingest.js` and also auto-loads `diagnostics.runtime.js`; server retains legacy files alongside new ones.

---

## Section 5: What works vs what doesn't (verbatim samples)

**Works (at times):**

* Health/boot and standard routes are reachable.
  Example (UTC in log):

  ```
  [2025-09-07T16:55:03.285Z] listening on 8080
  [2025-09-07T16:55:03.290Z] [BOOT] route dump for Express app:
  [BOOT] route: GET /api/news/serp/env
  …
  [BOOT] route: GET /api/news/serp/backfill
  …
  [BOOT] route: GET /api/news/serp/backfill-run
  [BOOT] route: GET /api/news/serp/backfill-diag
  ```
* `ROSTER` loading:

  ```
  [ROSTER] Loaded 121 active representatives from data/ab-roster-transformed.json
  ```

**Doesn't work / inconsistent:**

* When ingest module fails to load:
  `{"error":"Not found (fallback)","path":"/api/routes","bootPhase":"ingest-load-failed"}`
* Backfill streaming path(s) are not stable; `/api/news/serp/backfill-patch` frequently 404, duplicate entries in `/api/routes`, or present but inert.
* Diagnostic/backfill-test paths (`backfill-run`, `backfill-diag`) showed in route dump but returned 404 at client.

---

## Section 6: Ingest endpoint saga — timeline (CT timestamps)

> All times converted to **Central Time (CT)** from UTC logs you provided.

* **2025-09-05 06:10 CT** – Boot: route dump shows `backfill_stub`, `backfill`, **two** `backfill-patch` entries, plus env/selftest/vendor-probe.
  *("\[BOOT] route: GET /api/news/serp/backfill-patch" appears twice.)*

* **2025-09-05 09:45 CT onward** – Numerous GETs to `/api/news/serp/backfill?...` with `limit=50` and `store=1` per log lines (e.g., *"Delegating to Express app: GET /api/news/serp/backfill?who=…"*), implying earlier hard caps and active backfill usage.

* **2025-09-05 12:10–14:10 CT** – Duplicate `backfill-patch` remains on each boot. Attempts to hit `/api/admin/backfill` logged as delegated but route not returning streaming output.

* **2025-09-06 11:20–12:52 CT** – Same duplicate `backfill-patch`, plus multiple `/api/admin/backfill` delegates; still no streaming output.

* **2025-09-07 11:54 CT** – Clean boot shows ingest loaded and **now** includes:
  `backfill_stub`, `backfill`, `backfill-run`, and `backfill-diag` (in addition to env/selftest/vendor-probe/roster routes).
  **Immediately after**, calls to `/api/news/serp/backfill-run` are *delegated* but the client still receives 404.

* **2025-09-07 11:45–12:45 CT** – Repeated restarts show same pattern: ingest module loads; the route dump lists the expected paths, but client receives 404 or cancellation:
  *"Exception Message : The operation was canceled. … ProxyMiddleware.Invoke"*.

* **2025-09-07 12:52–14:19 CT** – Periodic GET `/` continues (platform probes). No route-level errors logged; `/api/news/serp/backfill-run` still in the route dump.

---

## Section 7: CI/CD realities (as observed)

* Deploys via Oryx; Node 20.19.3; "Build Operation ID" values logged.
* Multiple deploy cycles recorded; "Site is running with deployment version: …" messages show different deployment IDs across attempts.
* Evidence of policy gate on repo: *"remote: Bypassed rule violations for refs/heads/main: Changes must be made through a pull request."* — pushes still went through.
* Post-deploy drift persists (server has files not mirrored in most recent local edits), implying the deploy model is not strictly replacing prior content.
* No SPN/publish-profile details provided in this thread; actual workflow YAMLs not provided.

---

## Section 8: App settings & environment (names only; values **not provided**)

> **SENSITIVE – DO NOT COMMIT** once values are supplied.

* `NEWS_API_KEY` — NewsAPI client; absent → *"NewsAPI client disabled"*.
* `NEWSDATAIO_API_KEY` — NewsData client; absent → *"NewsData client disabled"*.
* `OPENAI_API_KEY`, `ANTHROPIC_API_KEY` — Agents (stance pipeline).
* `AZURE_MAPS_API_KEY` — Mapping.
* `GMAIL_APP_PASSWORD` — Mailer integration (if used).
* `AzureWebJobsStorage` — Azure storage connection string.
* `ROSTER_PATH` — path used at boot (logs show `data/ab-roster-transformed.json`).
* Any others currently configured: **not provided**.

---

## Section 9: Verification artifacts (what we checked vs. observed)

* **Health**: `/api/health` → 200 when ingest loaded.
* **Routes**: `/api/routes` → route dump lists **all** active paths; duplicate `/api/news/serp/backfill-patch` appeared many times; later replaced by `backfill-run` and `backfill-diag`.
* **Roster load**: log line
  `"[ROSTER] Loaded 121 active representatives from data/ab-roster-transformed.json"`.
* **Backfill call traces**: hundreds of `Delegating to Express app: GET /api/news/serp/backfill?...` lines with `who=...&days=365&limit=50&store=1` in earlier runs (showing the historical hard cap via querystring).

**Failure signatures:**

* `{"error":"Not found (fallback)","path":"/api/routes","bootPhase":"ingest-load-failed"}` → ingest module didn't load.
* `Exception Message : The operation was canceled. … ProxyMiddleware.Invoke` → platform canceled upstream request; client often saw 404 afterward.

---

## Section 10: Problems & why we got stuck (root causes only)

1. **Route drift & duplication on server**: legacy runtime files (`diagnostics.runtime.js`, `*.bak`) coexisted with current code, registering duplicate/conflicting routes (`/api/news/serp/backfill-patch`, stub variants).

2. **Non-deterministic content on `/wwwroot`**: Deployments did **not** fully replace prior content; server retained old modules that local repo no longer had.

3. **Ingest load/order complexity**: Boot sequence tries multiple candidate entrypoints; several failures were logged (missing modules) before settling on `express-ingest/ingest`. Result: unpredictable route set per boot.

4. **Historical hard caps**: request log shows repeated `limit=50`; this created the initial "cap" narrative, and those requests are preserved in BOOT.log.

5. **Diagnostic endpoints returning 404 despite route dump showing them**: Platform cancellation and/or catch-all interplay resulted in user-facing 404 while routes were present in the dump.

---

## Section 11: How I like to work (from your instructions)

* Facts > theories. KISS. No changes without approval.
* One problem at a time. Deterministic deploys. No secrets in code.
* Explicit success criteria. Central Time (CT) in logs.
* Only Azure + Cursor; do **not** patch on Kudu except when explicitly instructed for a single, reversible change.

---

## Section 12: F-Series Roadmap (what, not how)

* **F1** — Backfill 12 months for 121 officials into `news/raw/serp/<slug>/...` with PRD query terms; no caps.
* **F2** — Flagger: snippet-level filter → `news/flagged/...`.
* **F3** — Scraper: one fetch, readability, mark paywalled → `news/full/...`.
* **F4** — Agents 1–3: relevance → stance scoring → verification → `news/stance/...`.
* **F5** — Stance index: `stances/index.json` + per-official history.
* **F6** — App integration: stance badge + evidence link + "Contact" (mailto).
* **F7** — Monitoring: ingestion/scrape/agent disagreement metrics.
* **F8** — Cadence: weekly refresh pipeline (ingest → stance → index).
* **F9** — Retention/purge policy: raw retention (18 mo), paywalled skipped.
* **F10** — Expansion: add mayors (after MLA/MP stable).

---

## Section 13: Canonical references

* App: `https://canadawill-ingest-ave2f8fjcxeuaehz.canadacentral-01.azurewebsites.net`
* Kudu: `https://canadawill-ingest-ave2f8fjcxeuaehz.scm.canadacentral-01.azurewebsites.net`
* Live filepaths referenced in logs:

  * `/home/site/wwwroot/server.js`
  * `/home/site/wwwroot/express-ingest/ingest.js`
  * `/home/site/wwwroot/express-ingest/diagnostics.runtime.js`
  * `/home/site/wwwroot/express-ingest/serp-tools.runtime.js` (and multiple `.bak` versions)
  * `/home/site/wwwroot/BOOT.log`

---

## Section 14: Known dead ends (do not repeat)

* Editing multiple route files on server side (produced duplication and drift).
* Attempting to register new routes while server retains old stubs (causes 404/Not-found fallback or cancellation).
* Expecting `/api/admin/backfill` while it wasn't present in the actual loaded module set.

---

## Section 15: Open questions (from source material)

* Exact app settings (names **and values**) currently applied to the ingest app.
* Which GitHub workflow (if any) is the authoritative deployment?
* Whether "Run From Package" is enabled to prevent drift.
* Frontend/app URL and storage account/container details for verification of blob writes into `news/...`.

---

# Development Log (CT)

> CT = Central Time. Derived from UTC in BOOT.log and your messages.

**2025-09-03 03:05–03:25 CT**

* Backfill traffic begins via `/api/news/serp/backfill?who=...&days=365&limit=50&store=1` across many officials. (Ref: BOOT.log lines \~1931–2068).
* Evidence of **limit=50** in requests.

**2025-09-04 09:45–10:59 CT**

* More delegated GETs to `/api/news/serp/backfill` with `limit=50` continue (dozens of officials). (Ref: lines \~2391–2467).
* Boot shows duplicate `backfill-patch` registrations. (Ref: lines \~2977, 2979).

**2025-09-05 12:10–14:10 CT**

* Repeated GET `/api/admin/backfill` appear (delegated), but no streaming output captured.
* Duplicate `/api/news/serp/backfill-patch` entries at every boot.

**2025-09-05 13:32–13:48 CT**

* Backfill requests with `topic=separation` begin (e.g., *`/api/news/serp/backfill?who=jasraj-hallan&topic=separation&days=365&store=1`*).
* This indicates PRD term adoption in use by some path.

**2025-09-05 14:10–14:45 CT**

* Continued topic=separation calls across many MPs/MLAs.
* Duplicate `backfill-patch` persists at each boot cycle.

**2025-09-06 10:20–12:52 CT**

* `/api/admin/backfill` repeatedly delegated; still no evidence of streaming progress logs.
* `/api/news/serp/backfill-patch` duplicate remains.

**2025-09-07 11:54 CT**

* Boot: ingest loaded from `./express-ingest/ingest`; route dump now includes:
  `/api/news/serp/backfill`, `/api/news/serp/backfill-run`, `/api/news/serp/backfill-diag`, `/api/news/serp/backfill_stub`, plus env/selftest/vendor-probe/roster routes.
* Immediately after, attempts to call `/api/news/serp/backfill-run` are "Delegating to Express app", but client receives 404 or cancellation (platform proxy):
  *"Exception Message : The operation was canceled. … ProxyMiddleware.Invoke"*.

**2025-09-07 12:52–14:19 CT**

* Periodic GET `/` continues (probes). No route-level error surfaced; `/api/news/serp/backfill-run` still in the route dump.

**2025-09-07 14:52–15:22 CT**

* More restarts with the same boot pattern: `ingest-minimal.js` and `dist/ingest` fail; `./express-ingest/ingest` loads; routes include `backfill-run` and `backfill-diag`. Calls to `backfill-run` continue to be delegated, with client-visible 404.

**2025-09-07 16:27–16:53 CT**

* Delegations recorded for `/api/news/serp/backfill-run`; client still sees `{"error":"Not found"}`.
* Later `/api/routes` attempt returns *`{"error":"Not found (fallback)","path":"/api/routes","bootPhase":"ingest-load-failed"}`* (ingest loader failed on that boot).

---

## Appendix A — Raw logs (selected)

> You provided large excerpts; below are representative verbatim lines.

* Duplicate route registrations:

  ```
  [BOOT] route: GET /api/news/serp/backfill-patch
  [BOOT] route: GET /api/news/serp/backfill-patch
  ```
* Roster load:

  ```
  [ROSTER] Loaded 121 active representatives from data/ab-roster-transformed.json
  ```
* Disabled providers:

  ```
  NewsAPI client disabled: NEWS_API_KEY not set
  NewsData client disabled: NEWSDATAIO_API_KEY not set
  ```
* Platform cancellation:

  ```
  Exception Message : The operation was canceled.
  ... at Microsoft.AspNetCore.Proxy.ProxyMiddleware.Invoke(HttpContext context)
  ```
* Fallback on route list:

  ```
  {"error":"Not found (fallback)","path":"/api/routes","bootPhase":"ingest-load-failed"}
  ```

(Full multi-hundred-line BOOT.log tail you pasted has been summarized in the Development Log above; exact slices with CT conversions are included there.)

---

## Appendix B — CI/CD workflow names

* Not provided. Repo notices include:

  ```
  remote: Bypassed rule violations for refs/heads/main:
  remote: - Changes must be made through a pull request.
  ```

---

## Appendix C — Screenshots

* Not included here; you indicated Kudu/portal screenshots exist. If you want them embedded, supply the images or a link set.

---

## Appendix D — Kudu/portal extracts

* **Oryx/Node**

  ```
  Oryx Version: 0.2.20250611.1 ... 
  nodejs: 20.19.3
  ```
* **Startup**

  ```
  Running ... exec node server.js
  [BOOT] trying candidate path: ./ingest-minimal.js
  [BOOT] candidate path ./ingest-minimal.js failed: Cannot find module './routes/serp-unlimited'
  [BOOT] trying candidate path: ./express-ingest/dist/ingest
  [BOOT] candidate path ... failed: Cannot find module './express-ingest/dist/ingest'
  [BOOT] trying candidate path: ./express-ingest/ingest
  [BOOT] ingest module loaded from ./express-ingest/ingest
  listening on 8080
  ```
* **Route dump examples** (repeated each boot):

  ```
  [BOOT] route: GET /api/news/serp/env
  [BOOT] route: GET /api/news/serp/selftest
  [BOOT] route: GET /api/news/serp/backfill_stub
  [BOOT] route: GET /api/news/serp/refresh
  ...
  [BOOT] route: GET /api/news/serp/backfill
  [BOOT] route: GET /api/news/serp/backfill-run
  ...
  [BOOT] route: GET /api/news/serp/backfill-diag
  ...
  ```

---

## Appendix E — App Settings & Secrets (SENSITIVE – DO NOT COMMIT)

> Names listed; **values were not provided** in this thread. Paste exact `name=value` pairs here when available.

* `NEWS_API_KEY=`
* `NEWSDATAIO_API_KEY=`
* `OPENAI_API_KEY=`
* `ANTHROPIC_API_KEY=`
* `AZURE_MAPS_API_KEY=`
* `GMAIL_APP_PASSWORD=`
* `AzureWebJobsStorage=`
* `ROSTER_PATH=` (logs show `data/ab-roster-transformed.json`)
* Any others currently configured: *(not provided)*

---

**End of dossier.**
