# Development Log - 2025-08-17

## Run Start
- **UTC Timestamp**: 2025-08-17 20:30:00 UTC
- **Base URL**: https://canadawill-ingest-ave2f8fjcxeuaehz.canadacentral-01.azurewebsites.net
- **Budgets**: NewsAPI 0/80, NewsData 0/160
- **Storage Connected**: ‚úÖ Yes

## Issue Investigation: News Providers Not Returning Articles

### Problem Identified
After implementing the article retrieval endpoint (`/api/news/articles/:slug`), it was discovered that:
1. The ingest process completes successfully but returns 0 articles
2. Budget usage remains at 0 (no API calls are being tracked)
3. No articles are being stored in blob storage

### Root Cause Analysis
The issue is **NOT** with storage or retrieval logic, but with the news provider clients themselves:
- NewsAPI and NewsData clients are not returning any articles
- This results in 0 articles being stored and 0 budget usage

### Debugging Steps Taken

#### 1. Enhanced Logging
- Added comprehensive logging to both NewsAPI and NewsData clients
- Added detailed logging to the orchestrator for storage operations
- Added logging for API request construction and responses

#### 2. API Key Validation
- Tested both news provider APIs locally with simple queries
- **DISCOVERED**: Local environment variables are not set correctly
- **NEWS DATA**: Returns "The provided API key is not valid" with code "Unauthorized"
- **NEWS API**: Returns "Your API key is invalid or incorrect" with code "apiKeyInvalid"

#### 3. Azure Environment Check
- Confirmed that both providers show as "active" in Azure
- Confirmed that environment variables are configured in Azure App Service
- This suggests the issue is not with API keys in production

#### 4. Query Construction Analysis
- Current query format: `"Michelle Rempel Garner" OR "M. Rempel Garner" OR "Rempel Garner, Michelle" OR "Calgary" OR "Calgary Nose Hill"`
- Date range: 30 days (from 2024-07-17 to 2025-08-17)
- Language: English only

### Current Status
- **Deployment**: ‚úÖ Latest code with enhanced logging deployed successfully
- **Storage**: ‚úÖ Connected and working
- **News Providers**: ‚ùå Not returning articles (0 results from both providers)
- **Budget Tracking**: ‚ùå Not incrementing due to 0 results

### Next Steps
1. Investigate if the news provider APIs are working correctly in Azure
2. Check if the query construction is too complex or restrictive
3. Verify if the date range is causing issues
4. Consider testing with simpler queries to isolate the problem

### Technical Details
- **NewsData.io Endpoint**: `https://newsdata.io/api/1/news`
- **NewsAPI Endpoint**: `https://newsapi.org/v2/everything`
- **Query Strategy**: Combines person name, aliases, riding, and city
- **Date Range**: 30 days from current date
- **Language Filter**: English only
- **Page Size**: 100 articles per provider

## Comprehensive Issue Summary & Debugging Journey

### **Phase 1: Initial Implementation & Route Registration Issues**
**Timeline**: Early development session
**Issues Encountered**:
1. **TypeScript Compilation Errors**: `TS18046: 'error' is of type 'unknown'` in strict mode
   - **Solution**: Explicitly cast `error` to `any` in catch blocks
   - **Files Fixed**: `src/routes/newsRoutes.ts`, `src/ingest/orchestrator.ts`

2. **API Endpoints Returning 404**: `{"error": "Not found", "path": "/", "method": "GET"}`
   - **Root Cause**: Routes not being registered due to module loading failures
   - **Investigation**: Created minimal test script (`test-simple.js`) to isolate module loading
   - **Solution**: Fixed `app.js` import and made `BlobStore` initialization fault-tolerant

### **Phase 2: Deployment & Infrastructure Issues**
**Timeline**: Mid-development session
**Issues Encountered**:
1. **Deployment Failure**: Site couldn't start, Application Error
   - **Root Cause**: Missing `node_modules` in deployment package
   - **Solution**: Modified `zip` command to include `node_modules`

2. **Azure Resource Discovery**: Incorrect resource group and web app names
   - **Root Cause**: Using outdated resource names from previous attempts
   - **Solution**: Used `az group list` and `az webapp list` to identify correct resources
   - **Correct Resources**: `CanadaWill-prod2-rg` ‚Üí `canadawill-ingest`

### **Phase 3: Core Functionality Implementation**
**Timeline**: Mid-development session
**Issues Encountered**:
1. **Missing BlobStore Methods**: `Property 'listBlobs' does not exist on type 'BlobStore'`
   - **Solution**: Implemented `listBlobs`, `readJson`, and `streamToString` methods

2. **Missing Orchestrator Methods**: `Property 'deduplicateArticles' does not exist`
   - **Solution**: Implemented `deduplicateArticles` helper method

3. **Incorrect Azure SDK Usage**: `Property 'uploadData' does not exist on type 'BlobClient'`
   - **Solution**: Corrected to use `BlockBlobClient.upload` method

### **Phase 4: News Provider Integration Issues (Current Blocking Issue)**
**Timeline**: Late development session - ONGOING
**Issues Encountered**:
1. **Silent Failure**: Ingest operations complete successfully but return 0 articles
   - **Symptoms**: 
     - `/api/news/articles/:slug` returns empty arrays
     - Budget usage remains at 0
     - No articles stored in blob storage
   - **Impact**: Core functionality completely blocked

2. **Enhanced Logging Implementation**: Added comprehensive logging throughout the system
   - **NewsAPI Client**: Query construction, API requests, responses, fallback logic
   - **NewsData Client**: Same comprehensive logging pattern
   - **Orchestrator**: Storage operations, budget tracking, error handling
   - **BlobStore**: Upload attempts, retry logic, detailed error messages

3. **Query Strategy Refinement**: Implemented fallback mechanisms
   - **Primary Strategy**: Complex queries combining name, aliases, riding, and city
   - **Fallback Strategy**: Simple queries using just the person's name
   - **Date Range**: 30-day window with proper ISO date formatting
   - **Language Filter**: English only

4. **API Key Validation**: Tested both providers locally
   - **Local Environment**: API keys not set, both providers return authentication errors
   - **Azure Environment**: Both providers show as "active" in status endpoint
   - **Conclusion**: Issue is not with API keys in production

### **Phase 5: Current Investigation & Next Steps**
**Timeline**: Current - ONGOING
**Current Understanding**:
- **Storage Infrastructure**: ‚úÖ Fully functional and connected
- **API Endpoints**: ‚úÖ All responding correctly
- **News Provider Clients**: ‚ùå Not returning articles despite successful API calls
- **Budget Tracking**: ‚ùå Not incrementing due to 0 results

**Hypotheses for Root Cause**:
1. **Query Restrictions**: News providers may have limitations on political content
2. **Date Range Issues**: 30-day window might be too restrictive or date format incorrect
3. **Content Filtering**: Providers might be filtering out certain types of content
4. **Hidden Rate Limiting**: Silent rejection of requests without error responses
5. **Query Complexity**: Current query strategy might be too sophisticated for the APIs

**Immediate Next Steps**:
1. **Test Simple Queries**: Verify APIs work with basic terms like "Canada" or "Alberta"
2. **Reduce Date Range**: Test with 7-day or 1-day windows
3. **Simplify Query Strategy**: Test with just person names, no aliases or location hints
4. **Check API Documentation**: Verify current query parameters and restrictions
5. **Monitor Azure Logs**: Look for any hidden errors or rate limiting in Application Insights

### **Technical Architecture Status**
**‚úÖ Working Components**:
- Express server and routing
- Azure Blob Storage connection and operations
- News provider client initialization and API key validation
- Budget tracking and rate limiting infrastructure
- Article retrieval and storage endpoints
- Comprehensive logging and error handling

**‚ùå Blocking Issues**:
- News provider APIs not returning articles
- Budget tracking not incrementing
- No articles being stored for retrieval

**üîç Investigation Areas**:
- News provider API behavior and restrictions
- Query parameter validation and optimization
- Date range handling and format requirements
- Content filtering and rate limiting policies

## Run Summary
- **Total Slugs Attempted**: 1 (michelle-rempel-garner)
- **Total Articles Saved**: 0
- **Budgets Remaining**: NewsAPI 80/80, NewsData 160/160
- **Slugs with Errors**: None - all ingests complete successfully but return 0 articles
- **Core Issue**: News provider APIs not returning articles, not storage or retrieval problems
- **System Status**: Architecturally sound and ready - blocked by external API behavior
- **Next Priority**: Debug news provider integration to enable article retrieval functionality 